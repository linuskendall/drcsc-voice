; vim: set filetype=asterisk
;--

TODO:
- Allow registration of users with previously unseen caller ids 
- Sort message by user 
- Allow replies to messages
- Allow delete by user
- Implement lists of already "heard" messages
- Filter users own messages
- Handle caller ids without any user
- Set-up notifications for user of replies
- Set up check for minimum length of recorded message, discard messages shorter than say 20-30 seconds
--;
; vim: set filetype=asterisk
[farmers-network]
exten => s,1,Answer(500)
  same => n,MYSQL(Connect connid localhost drcsc drcsc drcsc)
  same => n,GotoIf($["${connid}" = ""]?e,1)
  same => n,agi(googletts.agi,"Welcome to DRCSC.",en,123)
  same => n(loop),agi(googletts.agi,"Press 1 to record message",en,123)
  same => n(loop),agi(googletts.agi,"Press 2 to hear new messages",en,123)
  same => n(loop),agi(googletts.agi,"Press 3 to hear your messages",en,123)
  same => n,WaitExten()

exten => 1,1,Goto(farmers-network-record,s,1)
exten => 2,1,Goto(farmers-network-listen,s,1)
exten => 3,1,Goto(farmers-network-own,s,1)

exten => i,1,Playback(option-is-invalid)
  same => n,Goto(s,loop)
 
exten => t,1,Playback(are-you-still-there)
  same => n,Goto(s,loop)

exten => e,1,Playback(an-error-has-occurred)
  same => n,Hangup

exten => h,1,MYSQL(Disconnect ${connid})

; Record a new message to channel
[farmers-network-record]
exten => s,1,agi(googletts.agi,"Record your message and end with #",en)
  same => n,MYSQL(Query resultid ${connid} INSERT INTO messages SET callid='${UNIQUEID}', callerid='${CALLERID(num)}', replyto=-1)
  same => n,MYSQL(Query resultid ${connid} SELECT LAST_INSERT_ID());
  same => n,GotoIf($["${resultid}" = ""]?farmers-network,e,1)
  same => n,MYSQL(Fetch fetchid ${resultid} insertid)
  same => n,MYSQL(Clear ${resultid})
  same => n,Record(/tmp/recording.${UNIQUEID}.${insertid}.ulaw)
  same => n,MYSQL(Query resultid ${connid} UPDATE messages SET filename='/tmp/recording.${UNIQUEID}.${insertid}' WHERE id=${insertid})
  same => n,Goto(farmers-network,s,loop)

exten => h,1,Goto(farmers-network,h,1)

; Hear all current messages on channel
[farmers-network-listen]
exten => s,1,MYSQL(Query resultid ${connid} SELECT COUNT(*) FROM messages WHERE replyto = -1 AND callerid != ${CALLERID(num)}) ; Fetch all top level messages (not replies)
  same => n,GotoIf($["${resultid}" = ""]?farmers-network,e,1)
  same => n,MYSQL(Fetch fetchid ${resultid} COUNT)
  same => n,MYSQL(Clear ${resultid})
  same => n,Playback(there-are)
  same => n,SayNumber(${COUNT})
  same => n,Playback(vm-messages)
  same => n,Set(MESSAGEN=0)
  same => n,MYSQL(Query resultid ${connid} SELECT id, callerid, filename FROM messages WHERE replyto=-1 AND callerid != ${CALLERID(num)}) ; Fetch all non reply messages
  same => n,GotoIf($["${resultid}" = ""]?farmers-network,e,1)
  same => n(fetch),MYSQL(Fetch fetchid ${resultid} id callerid filename)
  same => n,GotoIf($[${fetchid}]?:endresult)
  same => n,Set(MESSAGEN=$[${MESSAGEN}+1])
  same => n(play),Background(vm-message)
  same => n,SayNumber(${MESSAGEN}) ;SayNumber(${callerid})
  same => n,Background(${filename})  ; The user can dial any input here
  same => n(beep),Playback(beep)
  same => n,Goto(fetch)
  same => n(endresult),MYSQL(Clear ${resultid})
  same => n,Goto(farmers-network,s,loop)

; Record a reply
exten => 1,1,GotoIf($["${id}" = ""]?farmers-network,e,1)
  same => n,agi(googletts.agi,"Record your reply and end with #",en)
  same => n,MYSQL(Query reply_resultid ${connid} INSERT INTO messages SET callid='${UNIQUEID}', callerid='${CALLERID(num)}', replyto='${id}')
  same => n,MYSQL(Query reply_resultid ${connid} SELECT LAST_INSERT_ID());
  same => n,GotoIf($["${reply_resultid}" = ""]?farmers-network,e,1)
  same => n,MYSQL(Fetch reply_fetchid ${reply_resultid} insertid)
  same => n,MYSQL(Clear ${reply_resultid})
  same => n,Record(/tmp/recording.${UNIQUEID}.${insertid}.ulaw)
  same => n,MYSQL(Query reply_resultid ${connid} UPDATE messages SET filename='/tmp/recording.${UNIQUEID}.${insertid}' WHERE id=${insertid})
  same => n,Goto(farmers-network-listen,s,fetch) ; go back to where we were

; Listen again
exten => 2,1,Goto(s,play) ; play the same result again

; Skip
exten => 3,1,Goto(s,fetch) ; skip to next

; Help
exten => 0,1,agi(googletts.agi,"Press 1 to record a reply, 2 to repeat and 3 to skip",en)
  same => n,Goto(s,play)

; Invalid option, play help
exten => i,1,Playback(option-is-invalid)
  same => n,Goto(0,1)
 
; Timeout
exten => t,1,Playback(are-you-still-there)
  same => n,Goto(s,play)

; Hang-up, jump to cleanup
exten => h,1,Goto(farmers-network,h,1)

; Read all the users messages
[farmers-network-own]
exten => s,1,MYSQL(Query resultid ${connid} SELECT COUNT(*) FROM messages WHERE replyto = -1 AND callerid = ${CALLERID(num)}) ; Fetch all top level messages (not replies)
  same => n,GotoIf($["${resultid}" = ""]?farmers-network,e,1)
  same => n,MYSQL(Fetch fetchid ${resultid} COUNT)
  same => n,MYSQL(Clear ${resultid})
  same => n,Playback(vm-youhave)
  same => n,SayNumber(${COUNT})
  same => n,Playback(vm-messages)
  same => n,Set(MESSAGEN=0)
  same => n,MYSQL(Query resultid ${connid} SELECT id, callerid, filename FROM messages WHERE replyto=-1 AND callerid = ${CALLERID(num)}) ; Fetch all non reply messages
  same => n,GotoIf($["${resultid}" = ""]?farmers-network,e,1)
  same => n(fetch),MYSQL(Fetch fetchid ${resultid} id callerid filename)
  same => n,GotoIf($[${fetchid}]?:endresult)
  same => n,Set(MESSAGEN=$[${MESSAGEN}+1])
  same => n,Playback(vm-message)
  same => n,SayNumber(${MESSAGEN})
  same => n(play),Background(${filename})
  same => n,Playback(beep)
  same => n,Goto(fetch)
  same => n(endresult),MYSQL(Clear ${resultid})
  same => n,Goto(farmers-network,s,loop)

; Help
exten => 0,1,agi(googletts.agi,"Press 1 to listen to replies, 2 to repeat message, 3 to skip or 4 to delete")
  same => n,Goto(s,play)

; Listen to replies 
exten => 1,1,Goto(s,fetch) ; No action right now

; Listen again
exten => 2,1,Goto(s,play) ; play the same result again

; Skip
exten => 3,1,Goto(s,fetch) ; skip to next

; Delete
exten => 4,1,GotoIf($["${id}" = ""]?farmers-network,e,1)
  same => n,MYSQL(Query resultid ${connid} DELETE FROM messages WHERE id=${id} AND callerid = ${CALLERID(num)}) ; Fetch all non reply messages
  same => n,Playback(vm-deleted)
  same => n,Goto(s,fetch) ; Go to next

; Invalid option, play help
exten => i,1,Playback(option-is-invalid)
  same => n,Goto(0,1)
 
; Timeout
exten => t,1,Playback(are-you-still-there)
  same => n,Goto(s,play)

; Hang-up, jump to cleanup
exten => h,1,Goto(farmers-network,h,1)
